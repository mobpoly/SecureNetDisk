# 安全网络加密磁盘系统 - 技术文档

## 1. 系统概述

本系统是一个基于安全认证、加密传输和加密存储的网络加密磁盘系统，采用 Python 全栈开发，实现了端到端加密的文件存储和共享功能。

### 1.1 技术架构

| 组件 | 技术选型 |
|------|----------|
| 架构模式 | 客户端-服务器 (C/S) |
| 开发语言 | Python 3.8+ |
| UI 框架 | PyQt6 (Material Design) |
| 数据库 | SQLite |
| 加密库 | PyCryptodome, bcrypt |

### 1.2 安全特性

| 功能 | 实现方案 |
|------|----------|
| 密码传输 | SHA-256 预哈希（客户端） |
| 密码存储 | bcrypt 加盐哈希（服务端） |
| 通信加密 | AES-256-CTR + HMAC-SHA256 |
| 密钥交换 | Diffie-Hellman (RFC 3526 Group 14) |
| 文件加密 | AES-256-CBC (小文件) / AES-256-CTR (大文件) |
| 用户密钥 | RSA-2048（公私钥对） |
| 消息完整性 | HMAC-SHA256 |

---

## 2. 用户认证模块

### 2.1 用户注册

**流程**:
1. 用户输入用户名、邮箱、密码
2. 客户端验证密码强度（≥8位，包含字母和数字）
3. 客户端生成：
   - 主密钥 (32字节随机)
   - RSA 密钥对 (2048位)
   - 恢复密钥 (用于密码找回)
4. 密码 SHA-256 预哈希后发送
5. 服务端存储 `bcrypt(SHA256(password))`

### 2.2 用户登录

**双重认证方式**:

| 方式 | 说明 |
|------|------|
| 口令登录 | 用户名 + 密码 |
| 设备信任 | 已信任设备可跳过密码验证 |
| 验证码登录 | Email验证码（可选） |

**登录流程**:
1. 客户端对密码进行 SHA-256 预哈希
2. 发送预哈希值到服务端（通过加密通道）
3. 服务端使用 bcrypt 验证
4. 验证成功后返回用户加密数据
5. 客户端用密码解锁主密钥和私钥

### 2.3 设备信任

**功能**: 信任的设备可在一定时间内免密登录

**实现**:
- 设备令牌本地加密存储
- 服务端验证设备令牌
- 支持解除设备信任

### 2.4 密码管理

| 功能 | 说明 |
|------|------|
| 修改密码 | 使用旧密码验证后设置新密码 |
| 密码恢复 | 使用注册时的恢复密钥重置密码 |

---

## 3. 文件管理模块

### 3.1 文件上传（流式）

**流程**:
```
客户端                              服务端
   |                                   |
   |-- FILE_UPLOAD_START ------------->|  (文件名、大小、加密密钥)
   |<-- upload_id --------------------|
   |                                   |
   |-- FILE_UPLOAD_DATA (chunk 1) ---->|  直接写入临时文件
   |-- FILE_UPLOAD_DATA (chunk 2) ---->|  (不占用内存)
   |-- ...                             |
   |                                   |
   |-- FILE_UPLOAD_END --------------->|  shutil.move() 到存储位置
   |<-- success ----------------------|
```

**加密方式**:
- **小文件 (<100MB)**: AES-256-CBC，一次性加密
- **大文件 (≥100MB)**: AES-256-CTR，流式加密，写入临时文件

**内存优化**:
- 服务端：数据直接写入临时文件，不保存在内存
- 客户端：分块读取加密，每块~256KB

### 3.2 文件下载（流式）

**流程**:
```
客户端                              服务端
   |                                   |
   |-- FILE_DOWNLOAD_START ----------->|  请求文件元数据
   |<-- download_id, size, key -------|
   |                                   |
   |-- FILE_DOWNLOAD_DATA ------------->|  请求数据块
   |<-- chunk (256KB) ----------------|  从文件读取，不加载到内存
   |-- FILE_DOWNLOAD_DATA ------------->|
   |<-- chunk + is_complete ----------|
   |                                   |
   |====== 解密并保存到本地 ===========|
```

**解密方式**:
- **CBC模式 (小文件)**: 一次性解密
- **CTR模式 (大文件)**: 流式解密，直接写入输出文件

**内存优化**:
- 服务端：延迟打开文件句柄，按需读取
- 客户端：流式解密，~1-2MB 缓冲区

### 3.3 文件夹导航

**面包屑导航功能**:
- 点击 `← 返回上一级` 返回父目录
- 点击 `我的云盘` 或 `群组空间` 返回根目录
- 点击任意路径段跳转到该层级
- 路径过长自动显示 `...` 省略中间部分

**示例**:
```
← 返回上一级 | 我的云盘 / 文档 / 项目 / 2024 / 报告
                ↑          ↑      ↑       ↑      ↑
             返回根目录   点击任意层级可直接跳转
```

### 3.4 文件操作

| 操作 | 说明 | 快捷入口 |
|------|------|---------|
| 上传 | 加密并上传文件 | 工具栏 / 新建菜单 |
| 下载 | 下载并解密文件 | 右键菜单 |
| 新建文件夹 | 创建子目录 | 工具栏 / 新建菜单 |
| 重命名 | 修改名称 | 右键菜单 |
| 删除 | 删除文件/文件夹 | 右键菜单 |
| 刷新 | 重新获取列表 | 工具栏 |

---

## 4. 群组共享模块

### 4.1 群组密钥分发

**原理**: 群组密钥通过每个成员的 RSA 公钥加密后存储

```
群组密钥 (32字节)
      │
      ├─ RSA_encrypt(成员A公钥) → 存储
      ├─ RSA_encrypt(成员B公钥) → 存储
      └─ RSA_encrypt(成员C公钥) → 存储
```

### 4.2 群组操作

| 操作 | 说明 |
|------|------|
| 创建群组 | 生成群组密钥，创建者为管理员 |
| 邀请用户 | 获取用户公钥，加密群组密钥发送 |
| 接受邀请 | 用私钥解密群组密钥 |
| 群组文件 | 使用群组密钥加密，所有成员可解密 |

### 4.3 新文件通知

- 群组有新文件时显示徽章数字
- 进入群组后自动标记为已读
- 轮询刷新通知状态

---

## 5. 安全通信协议

### 5.1 握手流程

```
客户端                              服务端
   |                                   |
   |-- CLIENT_HELLO (DH 公钥) -------->|
   |                                   |
   |<-- SERVER_HELLO (DH 公钥+签名) ---|
   |                                   |
   |-- KEY_EXCHANGE (验证) ----------->|
   |                                   |
   |<-------- FINISHED ----------------|
   |                                   |
   |======= 安全通道建立 ==============|
```

### 5.2 数据包格式

```
+----------------+----------------+----------------+----------------+
|  Magic (4B)    |  Version (1B)  |  Type (1B)     |  Flags (2B)    |
+----------------+----------------+----------------+----------------+
|  Sequence (4B)                 |  Timestamp (8B)                  |
+----------------+----------------+----------------+----------------+
|  Payload Length (4B)           |  HMAC (32B)                      |
+----------------+----------------+----------------+----------------+
|  Encrypted Payload (Variable)                                     |
+----------------+----------------+----------------+----------------+
```

### 5.3 安全机制

| 机制 | 作用 |
|------|------|
| 序列号 + 时间戳 | 防重放攻击 |
| HMAC-SHA256 | 消息完整性验证 |
| AES-256-CTR | 数据加密 |
| DH + RSA签名 | 密钥协商 + 防中间人 |

---

## 6. 密钥管理架构

### 6.1 密钥层级

```
用户密码
    │
    ├─── SHA-256 预哈希 ──→ 传输到服务端
    │
    └─── PBKDF2 派生 ──→ 主密钥加密密钥
                              │
                              └─── 解密主密钥
                                        │
                    ┌───────────────────┼───────────────────┐
                    ↓                   ↓                   ↓
               RSA 私钥            文件密钥             群组密钥
```

### 6.2 密钥存储

| 密钥类型 | 存储位置 | 加密方式 |
|----------|----------|----------|
| 密码哈希 | 服务端数据库 | bcrypt(SHA256(pwd)) |
| 主密钥 | 服务端 (加密) | AES(PBKDF2(pwd)) |
| RSA 私钥 | 服务端 (加密) | AES(主密钥) |
| RSA 公钥 | 服务端 (明文) | 无 |
| 文件密钥 | 服务端 (加密) | AES(主密钥) |
| 群组密钥 | 服务端 (加密) | RSA(用户公钥) |
| 设备令牌 | 客户端本地 | 本地加密 |

---

## 7. 项目结构

```
secure_disk/
├── client/                 # 客户端模块
│   ├── main.py            # 客户端入口
│   ├── network.py         # 网络通信 (流式上传/下载)
│   ├── key_manager.py     # 密钥管理
│   ├── file_crypto.py     # 文件加解密 (CBC/CTR)
│   ├── device_trust.py    # 设备信任管理
│   └── ui/                # 用户界面
│       ├── login_dialog.py  # 登录对话框
│       ├── main_window.py   # 主窗口 (面包屑导航)
│       └── styles.py        # 样式定义
│
├── server/                 # 服务端模块
│   ├── main.py            # 服务端入口
│   ├── tcp_server.py      # TCP 服务器
│   ├── handler.py         # 请求处理 (流式处理)
│   ├── database.py        # 数据库操作
│   └── file_storage.py    # 文件存储
│
├── crypto/                 # 加密模块
│   ├── aes.py             # AES 加密 (CBC/CTR/GCM)
│   ├── rsa.py             # RSA 加密
│   ├── dh.py              # DH 密钥交换
│   ├── hmac_auth.py       # HMAC 认证
│   └── kdf.py             # 密钥派生
│
├── protocol/               # 协议模块
│   ├── packet.py          # 数据包定义
│   ├── handshake.py       # 握手协议
│   ├── session.py         # 会话管理
│   └── secure_channel.py  # 安全通道
│
├── auth/                   # 认证模块
│   ├── user.py            # 用户模型
│   ├── password.py        # 密码处理
│   └── master_key.py      # 主密钥管理
│
├── groups/                 # 群组模块
│   ├── group_manager.py   # 群组管理
│   └── group_key.py       # 群组密钥
│
└── requirements.txt        # 依赖列表
```

---

## 8. 快速开始

### 8.1 安装依赖

```bash
pip install -r requirements.txt
```

### 8.2 启动服务端

```bash
python -m server.main
```

服务端默认监听 `localhost:9000`

### 8.3 启动客户端

```bash
python -m client.main
```

### 8.4 首次使用

1. 点击 "注册" 标签页
2. 填写用户名、邮箱、密码
3. 点击 "注册" 按钮
4. **保存显示的恢复密钥**（用于密码找回）
5. 注册成功后自动登录

---

## 9. 性能优化

### 9.1 大文件传输

| 优化项 | 实现 |
|--------|------|
| 流式上传 | 分块加密 + 直接写入临时文件 |
| 流式下载 | 分块读取 + 流式解密 |
| 内存占用 | 服务端~256KB/连接，客户端~1-2MB |

### 9.2 加密优化

| 文件大小 | 加密模式 | 特点 |
|----------|----------|------|
| <100MB | AES-CBC | 一次性加密，简单 |
| ≥100MB | AES-CTR | 流式加密，低内存 |

---

## 10. 注意事项

1. **恢复密钥**: 注册时请务必保存，这是找回密码的唯一方式
2. **密钥安全**: 所有密钥仅在客户端内存中解密，服务端无法获取明文
3. **端到端加密**: 文件在本地加密后上传，服务端存储的是密文
4. **群组安全**: 群组密钥通过 RSA 公钥加密分发，只有成员可解密
5. **大文件**: 支持GB级别文件传输，内存占用恒定

---

## 11. 版本信息

- **版本**: 1.1.0
- **更新日期**: 2026-01-13
- **主要更新**:
  - 流式上传/下载支持
  - 大文件CTR加密模式
  - 面包屑导航
  - 内存优化
  - 设备信任功能
